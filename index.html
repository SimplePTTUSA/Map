<!DOCTYPE html>
<html>
<head>
    <title>Weather Event Tracking Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        #map { height: 700px; }
        .refresh-button {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            padding: 8px;
            background: white;
            border: 1px solid #ccc;
            cursor: pointer;
        }
        .weather-icon {
            width: 32px;
            height: 32px;
            filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.5));
        }
        .popup-content { min-width: 200px; }
    </style>
</head>
<body>
    <div id="map"></div>
    <button class="refresh-button" onclick="loadData()">Refresh Data</button>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        // Weather icon configuration
        const iconConfig = {
            'tornado': 'https://openweathermap.org/img/wn/tornado.png',
            'funnel cloud': 'https://www.weather.gov/grb/funnel_cloud',
            'hail': 'https://openweathermap.org/img/wn/hail.png',
            'damaging winds': 'https://openweathermap.org/img/wn/strong-wind.png',
            'dense fog': 'https://openweathermap.org/img/wn/fog.png',
            'heavy snow': 'https://openweathermap.org/img/wn/snow.png',
            'fire': 'https://openweathermap.org/img/wn/fire.png',
            'flooding': 'https://openweathermap.org/img/wn/flood.png',
            'severe thunderstorm': 'https://openweathermap.org/img/wn/thunderstorm.png'
        };

        const map = L.map('map').setView([37.8, -96], 4);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        
        let markers = [];
        let processedEntries = new Set();

        async function loadData() {
            try {
                const response = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vRho62D5FolDwqTj_VkQDuT5K1yBMawOhib6dtH4t0i6wdRYIjbArb9EjsqLlDMeWMS-UAysMEq8drb/pub?output=csv');
                const csvData = await response.text();
                const rows = csvData.split('\n').slice(1); // Skip header

                for (const row of rows) {
                    const columns = row.split(',');
                    // Column indexes (0-based):
                    const timestamp = columns[0];    // Column 1 in Sheets
                    const name = columns[1];        // Column 2 in Sheets
                    const spotterId = columns[2];   // Column 3 in Sheets
                    const zip = columns[3];          // Column 4 in Sheets
                    const event = columns[5];        // Column 6 in Sheets
                    const notes = columns[6];        // Column 7 in Sheets
                    
                    const entryKey = `${zip}-${event}-${timestamp}`;
                    if (!zip || !event || processedEntries.has(entryKey)) continue;

                    const coords = await geocodeZip(zip);
                    if (coords) {
                        const icon = L.icon({
                            iconUrl: iconConfig[event.toLowerCase()] || 'https://openweathermap.org/img/wn/unknown.png',
                            iconSize: [32, 32],
                            iconAnchor: [16, 32]
                        });

                        const marker = L.marker(coords, { icon })
                            .addTo(map)
                            .bindPopup(`
                                <div class="popup-content">
                                    <h3>${event.toUpperCase()}</h3>
                                    <p><strong>Name:</strong> ${name}</p>
                                    <p><strong>Spotter ID:</strong> ${spotterId}</p>
                                    <p><strong>ZIP:</strong> ${zip}</p>
                                    <p><strong>Time:</strong> ${new Date(timestamp).toLocaleString()}</p>
                                    <p><strong>Notes:</strong> ${notes}</p>
                                </div>
                            `);

                        markers.push(marker);
                        processedEntries.add(entryKey);
                    }
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function geocodeZip(zip) {
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?postalcode=${zip}&country=US&format=json`
                );
                const data = await response.json();
                return data[0] ? [data[0].lat, data[0].lon] : null;
            } catch (error) {
                console.error('Geocoding error:', error);
                return null;
            }
        }

        // Initial load and refresh every 5 minutes
        loadData();
        setInterval(loadData, 300000);
    </script>
</body>
</html>
