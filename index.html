<!DOCTYPE html>
<html>
<head>
    <title>Zip Code Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        #map { height: 600px; }
        .refresh-button {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            padding: 8px;
            background: white;
            border: 1px solid #ccc;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <button class="refresh-button" onclick="loadData()">Refresh Data</button>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        // Initialize map
        const map = L.map('map').setView([37.8, -96], 4);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        
        let markers = [];
        let processedZips = new Set();

        async function loadData() {
            try {
                // Fetch CSV data
                const response = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vRho62D5FolDwqTj_VkQDuT5K1yBMawOhib6dtH4t0i6wdRYIjbArb9EjsqLlDMeWMS-UAysMEq8drb/pub?output=csv');
                const csvData = await response.text();
                const rows = csvData.split('\n').slice(1); // Remove header row

                // Process each row
                for (const row of rows) {
                    const columns = row.split(',');
                    const zip = columns[3]; // Fourth column (index 3)
                    if (!zip || processedZips.has(zip)) continue;

                    // Geocode zip code
                    const coords = await geocodeZip(zip.trim());
                    if (coords) {
                        const marker = L.marker(coords).addTo(map);
                        markers.push(marker);
                        processedZips.add(zip);
                    }
                }
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        async function geocodeZip(zip) {
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?postalcode=${zip}&country=US&format=json`
                );
                const data = await response.json();
                return data.length > 0 ? [data[0].lat, data[0].lon] : null;
            } catch (error) {
                console.error('Geocoding error:', error);
                return null;
            }
        }

        // Load initial data and refresh every 5 minutes
        loadData();
        setInterval(loadData, 300000);
    </script>
</body>
</html>
